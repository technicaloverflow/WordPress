window.GFStripe=null,function(l){GFStripe=function(e){for(var r in e)e.hasOwnProperty(r)&&(this[r]=e[r]);this.form=null,this.init=function(){if(this.isCreditCardOnPage()||"checkout"===this.stripe_payment){var o=this,d=null,g=!1,i=!1;switch(gform.addAction("gform_frontend_feeds_evaluated",function(e,r){d=null,i=g=!1;for(var t=0;t<Object.keys(e).length;t++)if("gravityformsstripe"===e[t].addonSlug&&e[t].isActivated){g=!0,d=o.feeds[t],"elements"===o.stripe_payment?(i=""!==d.address_zip,0<=s._elements.indexOf("card")&&m.destroy(),l(p).next(".validation_message").length&&l(p).next(".validation_message").html(""),(m=s.create("card",{classes:o.cardClasses,style:o.cardStyle,hidePostalCode:i})).mount(p),m.on("change",function(e){o.displayStripeCardError(e)})):"checkout"===o.stripe_payment&&("form_total"===d.paymentAmount&&(gform.addFilter("gform_product_total",function(e,r){return window["gform_stripe_checkout_amount_"+r]=e},51),gformCalculateTotalPrice(r)),o.updateCheckoutPaymentAmount(d));break}if(!g){if("elements"===o.stripe_payment)0<=s._elements.indexOf("card")&&m.destroy(),l(p).next(".validation_message").length||l(p).after('<div class="gfield_description validation_message"></div>'),l(p).next(".validation_message").html(gforms_stripe_frontend_strings.no_active_frontend_feed);o.form=l("#gform_"+r),o.resetStripeStatus(o.form,r,o.isLastPage())}}),o.stripe_payment){case"elements":var _=Stripe(this.apiKey),s=_.elements(),p="#input_"+o.formId+"_"+o.ccFieldId+"_1",m=null,f=!1;break;case"checkout":var r,t=l("#gform_"+this.formId),a={key:this.apiKey,token:function(e){l("#gf_stripe_response").length?l("#gf_stripe_response").val(l.toJSON(e)):t.append(l('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(l.toJSON(e))),t.submit()}};r=StripeCheckout.configure(a),l(document).on("gform_price_change",function(){l("#gf_stripe_response").length&&l("#gf_stripe_response").val(""),o.updateCheckoutPaymentAmount(d)}),l("#gform_submit_button_"+this.formId).on("click",function(e){if(g&&!t.data("gfstripesubmitting")){if(l("#gf_stripe_response").length&&""!==l("#gf_stripe_response").val())if(l.parseJSON(l("#gf_stripe_response").val()).id)return void t.submit();(a={amount:0===gf_global.gf_currency_config.decimals?window["gform_stripe_checkout_amount_"+o.formId]:100*window["gform_stripe_checkout_amount_"+o.formId],currency:gform.applyFilters("gform_stripe_currency",o.currency,o.formId),locale:"auto",image:d.logoUrl,name:GFMergeTag.replaceMergeTags(o.formId,d.name),description:GFMergeTag.replaceMergeTags(o.formId,d.description),zipCode:!0}).billingAddress=d.billingAddress,0<(a=gform.applyFilters("gform_stripe_checkout_options",a,o.formId)).amount&&(e.preventDefault(),a.amount=Math.round(a.amount),r.open(a))}}),window.addEventListener("popstate",function(){r.close()});break;case"stripe.js":Stripe.setPublishableKey(this.apiKey)}l("#gform_"+this.formId).submit(function(e){if(("stripe.js"===o.stripe_payment||g)&&!(l(this).data("gfstripesubmitting")||1==l("#gform_save_"+o.formId).val()||!o.isLastPage()&&"elements"!==o.stripe_payment||gformIsHidden(l(p))))switch(e.preventDefault(),l(this).data("gfstripesubmitting",!0),o.maybeAddSpinner(),o.stripe_payment){case"elements":o.form=l(this);var r=parseInt(l("#gform_source_page_number_"+o.formId).val(),10),t=parseInt(l("#gform_target_page_number_"+o.formId).val(),10);if(t<r&&0!==t&&(f=!0),o.isLastPage()&&!o.isCreditCardOnPage()||gformIsHidden(l(p))||f)return void l(this).submit();var i={name:l("#input_"+o.formId+"_"+o.ccFieldId+"_5").val(),address_line1:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_line1)),address_line2:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_line2)),address_city:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_city)),address_state:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_state)),address_zip:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_zip)),address_country:GFMergeTag.replaceMergeTags(o.formId,o.getBillingAddressMergeTag(d.address_country)),currency:gform.applyFilters("gform_stripe_currency",o.currency,o.formId)};_.createToken(m,i).then(function(e){o.elementsResponseHandler(e)});break;case"checkout":0<window["gform_stripe_checkout_amount_"+o.formId]?(o.form=l(this),o.checkoutResponseHandler()):l(this).submit();break;case"stripe.js":var s=l(this),a="input_"+o.formId+"_"+o.ccFieldId+"_",n={number:s.find("#"+a+"1").val(),exp_month:s.find("#"+a+"2_month").val(),exp_year:s.find("#"+a+"2_year").val(),cvc:s.find("#"+a+"3").val(),name:s.find("#"+a+"5").val()};o.form=s,Stripe.card.createToken(n,function(e,r){o.responseHandler(e,r)})}})}},this.getBillingAddressMergeTag=function(e){return""===e?"":"{:"+e+"}"},this.responseHandler=function(e,r){for(var t=this.form,i="input_"+this.formId+"_"+this.ccFieldId+"_",s=["1","2_month","2_year","3","5"],a=0;a<s.length;a++){var n=t.find("#"+i+s[a]);if("1"==s[a]){var o=l.trim(n.val()),d=gformFindCardType(o);void 0!==this.cardLabels[d]&&(d=this.cardLabels[d]),t.append(l('<input type="hidden" name="stripe_credit_card_last_four" />').val(o.slice(-4))),t.append(l('<input type="hidden" name="stripe_credit_card_type" />').val(d))}}t.append(l('<input type="hidden" name="stripe_response" />').val(l.toJSON(r))),t.submit()},this.elementsResponseHandler=function(e){var r=this.form;l("#gf_stripe_response").length?l("#gf_stripe_response").val(l.toJSON(e)):r.append(l('<input type="hidden" name="stripe_response" id="gf_stripe_response" />').val(l.toJSON(e))),e.error?(this.displayStripeCardError(e),this.resetStripeStatus(r,this.formId,this.isLastPage())):(r.append(l('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(e.token.card.last4)),r.append(l('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(e.token.card.brand)),r.submit())},this.checkoutResponseHandler=function(){var e=this.form,r=l.parseJSON(l("#gf_stripe_response").val());r.error||""===r?this.resetStripeStatus(e,this.formId,this.isLastPage()):(e.append(l('<input type="hidden" name="stripe_credit_card_last_four" id="gf_stripe_credit_card_last_four" />').val(r.card.last4)),e.append(l('<input type="hidden" name="stripe_credit_card_type" id="stripe_credit_card_type" />').val(r.card.brand)),e.submit())},this.isLastPage=function(){var e=l("#gform_target_page_number_"+this.formId);return!(0<e.length)||0==e.val()},this.isCreditCardOnPage=function(){var e=this.getCurrentPageNumber();return!this.ccPage||!e||this.ccPage==e},this.getCurrentPageNumber=function(){var e=l("#gform_source_page_number_"+this.formId);return 0<e.length&&e.val()},this.maybeAddSpinner=function(){if(!this.isAjax)if("function"==typeof gformAddSpinner)gformAddSpinner(this.formId);else{var e=this.formId;if(0==jQuery("#gform_ajax_spinner_"+e).length){var r=gform.applyFilters("gform_spinner_url",gf_global.spinnerUrl,e);gform.applyFilters("gform_spinner_target_elem",jQuery("#gform_submit_button_"+e+", #gform_wrapper_"+e+" .gform_next_button, #gform_send_resume_link_button_"+e),e).after('<img id="gform_ajax_spinner_'+e+'"  class="gform_ajax_spinner" src="'+r+'" alt="" />')}}},this.resetStripeStatus=function(e,r,t){l("#gf_stripe_response, #gf_stripe_credit_card_last_four, #stripe_credit_card_type").remove(),e.data("gfstripesubmitting",!1),l("#gform_ajax_spinner_"+r).remove(),t&&(window["gf_submitting_"+r]=!1)},this.displayStripeCardError=function(e){var r="#input_"+this.formId+"_"+this.ccFieldId+"_1";l(r).next(".validation_message").length||l(r).after('<div class="gfield_description validation_message"></div>');var t=l(r).next(".validation_message");e.error?(t.html(e.error.message),0<l("#gform_ajax_spinner_"+this.formId).length&&l("#gform_ajax_spinner_"+this.formId).remove()):t.html("")},this.updateCheckoutPaymentAmount=function(e){var r=this.formId;if("form_total"!==e.paymentAmount){var t=GFMergeTag.getMergeTagValue(r,e.paymentAmount,":price"),i=GFMergeTag.getMergeTagValue(r,e.paymentAmount,":qty");"string"==typeof t&&(t=GFMergeTag.getMergeTagValue(r,e.paymentAmount+".2",":price"),i=GFMergeTag.getMergeTagValue(r,e.paymentAmount+".3",":qty")),window["gform_stripe_checkout_amount_"+r]=t*i}e.hasOwnProperty("setupFee")&&(t=GFMergeTag.getMergeTagValue(r,e.setupFee,":price"),i=GFMergeTag.getMergeTagValue(r,e.setupFee,":qty"),"string"==typeof t&&(t=GFMergeTag.getMergeTagValue(r,e.setupFee+".2",":price"),i=GFMergeTag.getMergeTagValue(r,e.setupFee+".3",":qty")),window["gform_stripe_checkout_amount_"+r]+=t*i)},this.init()}}(jQuery);